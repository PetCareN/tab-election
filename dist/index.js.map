{"version":3,"file":"index.js","sources":["../src/leader-elector.js","../src/index.js"],"sourcesContent":["const VOTE_PERIOD = 500;\nconst HEARTBEAT = 500;\nconst ELECTION_MIN = 2000; // when not visible in browsers heartbeat is slowed down to 1000 ms, keep above this\nconst ELECTION_MAX = 3000;\n\nconst STATE_FOLLOWER = 'follower';\nconst STATE_CANDIDATE = 'candidate';\nconst STATE_LEADER = 'leader';\nconst STATE_CLOSED = 'closed';\n\n\n/**\n * Create an elector, listen in the callback provided in waitForLeadership() to know when this becomes the leader. Call\n * close() to disconnect. Ignore the other methods, they are not for you. This started off using raft but because of\n * the environment was simplified. setTimeout/setInterval are throttled to 1000ms in most browsers when the tab is not\n * the focus. Also they all share localStorage which is needed to trigger updates anyway, so we use that instead of\n * proper voting. It works great! Just don't lower the numbers above without testing because the throttling will\n * make multiple leaders become elected with lower numbers, even when voting was in place.\n */\nexport default class LeaderElector {\n\n  constructor(name) {\n    this.name = name;\n    this.state = STATE_CLOSED;\n    this.nodeId = createNodeId();\n    this.timeout = 0;\n    this.callback = null;\n    this.close = this.close.bind(this);\n  }\n\n  /**\n   * Wait until this tab becomes the leader, then do something about it. Once the leader, it will remain the leader\n   * until closed. The first tab open will almost immediately become the leader (within 100 ms).\n   * @return {LeaderElector} A reference to itself.\n   */\n  waitForLeadership(callback) {\n    this.callback = callback;\n    this.becomeFollower();\n    return this;\n  }\n\n  /**\n   * Close this leader elector. To restart it, you must call waitForLeadership again.\n   */\n  close() {\n    clearTimeout(this.timeout);\n    window.removeEventListener('unload', this.close);\n    if (this.state === STATE_LEADER) {\n      let leader = getLeaderInfo(this.name);\n      if (leader && leader.nodeId === this.nodeId) {\n        clearLeaderInfo(this.name);\n      }\n    }\n    this.state = STATE_CLOSED;\n  }\n\n\n  hasLeader() {\n    let leader = getLeaderInfo(this.name);\n    return leader && Date.now() - leader.timestamp < ELECTION_MIN;\n  }\n\n  becomeFollower() {\n    this.state = STATE_FOLLOWER;\n    clearTimeout(this.timeout);\n\n    let checkLeadership = () => {\n      // If no leader or the leader is long gone, immediately take leadership\n      if (!this.hasLeader()) return this.becomeCandidate();\n      let interval = Math.round(ELECTION_MAX - ELECTION_MIN * Math.random()) + ELECTION_MIN;\n      this.timeout = setTimeout(checkLeadership, interval);\n    };\n\n    checkLeadership();\n  }\n\n  becomeCandidate() {\n    this.state = STATE_CANDIDATE;\n    clearTimeout(this.timeout);\n\n    setLeaderInfo(this.name, this.nodeId);\n    this.timeout = setTimeout(() => {\n      // last one wins\n      let leader = getLeaderInfo(this.name);\n      if (leader.nodeId === this.nodeId) {\n        this.becomeLeader();\n      } else {\n        this.becomeFollower();\n      }\n    }, VOTE_PERIOD);\n  }\n\n  becomeLeader() {\n    this.state = STATE_LEADER;\n    clearTimeout(this.timeout);\n\n    let heartbeat = () => {\n      setLeaderInfo(this.name, this.nodeId);\n      this.timeout = setTimeout(heartbeat, HEARTBEAT);\n    };\n    heartbeat();\n    window.addEventListener('unload', this.close);\n    this.callback();\n  }\n}\n\n\n\nfunction getLeaderInfo(name) {\n  try {\n    return JSON.parse(localStorage.getItem(`leader:${name}`));\n  } catch(err) {\n    return null;\n  }\n}\n\nfunction setLeaderInfo(name, nodeId) {\n  localStorage.setItem(`leader:${name}`, JSON.stringify({ nodeId, timestamp: Date.now() }));\n}\n\nfunction clearLeaderInfo(name) {\n  localStorage.removeItem(`leader:${name}`);\n}\n\nconst chars = (\n  '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'\n).split('');\n\nfunction createNodeId() {\n  let id = '';\n  let length = 6;\n  while (length--) {\n    id += chars[Math.random() * chars.length | 0];\n  }\n  return id;\n}\n","import LeaderElector from './leader-elector';\n\nexport { LeaderElector };\n\n// Shortcut, returns the elector that you can later close, and calls the callback once this tab becomes the leader.\nexport function waitForLeadership(name, callback) {\n  if (typeof name === 'function') {\n    callback = name;\n    name = 'default';\n  }\n  let elector = new LeaderElector(name);\n  return elector.waitForLeadership(callback);\n}\n"],"names":["const","this","let"],"mappings":"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"}